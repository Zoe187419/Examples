earlybirdoffices<-c(2017,
                    2021,
                    2024,
                    2025,
                    2027,
                    2028,
                    2043,
                    2044,
                    2046,
                    2047,
                    2048,
                    2051,
                    2083,
                    2086,
                    2089,
                    2091,
                    2092,
                    2093,
                    2094,
                    2095,
                    2096,
                    2100,
                    2106,
                    2108,
                    2109,
                    2118,
                    2119,
                    2120,
                    2121,
                    2123,
                    2124,
                    2126,
                    2128,
                    2129,
                    2132,
                    2133,
                    2137,
                    2139,
                    2141,
                    2143,
                    2149,
                    2242,
                    2244,
                    2246,
                    2248,
                    2254,
                    2260,
                    2263,
                    2264,
                    2273,
                    2282,
                    2288,
                    2309,
                    2325,
                    2335,
                    2358,
                    2361,
                    2368,
                    2369,
                    2373,
                    2375,
                    2376,
                    2377,
                    2387,
                    2395,
                    2396,
                    2397,
                    2403,
                    2404,
                    2406,
                    2407,
                    2408,
                    2410,
                    2419,
                    2428,
                    2439,
                    2494,
                    2495,
                    2496,
                    2509,
                    2513,
                    2550,
                    2568,
                    2578,
                    2579,
                    2581,
                    2583,
                    2584,
                    2585,
                    2586,
                    2599,
                    2600,
                    2601,
                    2737,
                    2738,
                    2765,
                    3419,
                    3420,
                    3421,
                    3422,
                    3423,
                    3424,
                    3426,
                    3428,
                    3432,
                    3437,
                    3519,
                    3520,
                    3521,
                    3522,
                    3524,
                    3525,
                    3527,
                    3528,
                    3530,
                    3531,
                    3532,
                    3534,
                    3535,
                    3661,
                    3662,
                    3663,
                    3664,
                    3665,
                    3666,
                    3669,
                    3670,
                    3672,
                    4007,
                    4008,
                    4009,
                    4010,
                    4011,
                    4014,
                    4015,
                    4016,
                    4325,
                    4331,
                    4352,
                    4490,
                    4547,
                    4636,
                    4643,
                    4653,
                    4659,
                    4666,
                    4701,
                    4730,
                    4735,
                    4736,
                    4742,
                    4834,
                    4836,
                    4980,
                    4998,
                    5004,
                    5051,
                    5052,
                    5073,
                    5087,
                    5185,
                    5214,
                    5339,
                    5342,
                    6125,
                    6225,
                    6226,
                    6227,
                    6228,
                    6277,
                    6284,
                    6296,
                    6367,
                    6419,
                    6511,
                    6512,
                    6513,
                    6514,
                    6515,
                    7611,
                    7613,
                    7614,
                    7615,
                    7616,
                    7617,
                    7618,
                    7619,
                    7620,
                    7623,
                    7625,
                    7627,
                    7629,
                    7631,
                    7633,
                    7637,
                    7638,
                    7639,
                    7640,
                    7641,
                    7643,
                    7646,
                    7647,
                    7649,
                    7650,
                    7651,
                    7658,
                    7661,
                    7662,
                    7663,
                    7667,
                    7668,
                    7669,
                    7670,
                    7671,
                    7674,
                    7675,
                    7676,
                    7677,
                    7745,
                    7746,
                    7747,
                    7749,
                    7751,
                    7760,
                    7768,
                    7786,
                    7833,
                    7835,
                    7857,
                    7876,
                    7891,
                    7939,
                    7950,
                    7951,
                    19938,
                    19942,
                    19944,
                    19945,
                    19946,
                    19948,
                    19949,
                    19950,
                    19951,
                    19952,
                    19953,
                    19961,
                    19962,
                    19965,
                    19967,
                    19968,
                    19969,
                    19971,
                    19974,
                    19978,
                    19980,
                    19983,
                    19984,
                    19985,
                    19986,
                    19988,
                    19989,
                    19990,
                    19995,
                    19997,
                    19998,
                    19999,
                    20000,
                    20001,
                    20002,
                    20004,
                    20006,
                    20009,
                    20010,
                    20011,
                    20012,
                    20013,
                    20014,
                    20018,
                    20019,
                    20023,
                    20026,
                    20027,
                    20028,
                    20030,
                    20031,
                    20032,
                    20034,
                    20042,
                    20044,
                    20047,
                    20051,
                    20053,
                    20054,
                    20055,
                    20056,
                    20057,
                    20058,
                    20059,
                    20061,
                    20091,
                    20092,
                    20094,
                    20095,
                    20096,
                    20097,
                    20098,
                    20102,
                    20103,
                    20104,
                    20105,
                    20106,
                    20107,
                    20147,
                    20220,
                    20266,
                    20268,
                    20270,
                    20320,
                    20322,
                    20353,
                    20358,
                    20365,
                    20372,
                    20385,
                    20388,
                    20413,
                    20414,
                    20425,
                    20426,
                    20427,
                    20433,
                    20439,
                    20471,
                    20585,
                    20601,
                    20603,
                    20616,
                    20617,
                    20619,
                    20639,
                    20641,
                    20642,
                    27906,
                    27911,
                    27912,
                    27915,
                    27920,
                    27972,
                    27980,
                    27999,
                    28010,
                    28019,
                    28051,
                    28055,
                    38519,
                    38520,
                    38521,
                    38522,
                    38523,
                    38531,
                    38536,
                    38538,
                    38548,
                    38551,
                    48648,
                    48650,
                    48651,
                    48655,
                    48656,
                    48657)


#https://r.iq.harvard.edu/docs/matchit/2.4-20/matchit.pdf

setwd("G:/marketing/Marketing Analytics/Bohning_Jessica/Projects/2018/181031 SAS Optimal Matching Investigation/R Stuff")

library(dplyr)
library(tableone)
library(Matching)
library(MatchIt)
library(ggplot2)
library(optmatch)

rawdata<-read.csv(file="prematchdata.csv")

prematchdata<-rawdata %>%
  filter(new_1617_growth<2 &
           new_1718_growth<2 &
           prior_1617_growth<2 &
           prior_1718_growth<2 &
           
           new_1617_growth>-0.7 &
           new_1718_growth>-0.7 &
           prior_1617_growth>-0.7 &
           prior_1718_growth>-0.7
  )
#INSERT PILOT DATA HERE#
#
#
#
#
#
#
#
#
#
#
#


#Variables to match on
xvars<-c("total_17","new_1617_growth","prior_1617_growth", "avg_nac_17",
         "avg_cltotagi_17","prct_eitc_17")

prematchdata_b<-mutate(prematchdata,test_indicator=case_when(TAXLOCTN %in% earlybirdoffices ~ 1, TRUE~0))
rownames(prematchdata_b)<-prematchdata_b$TAXLOCTN

#look at a table 1
table1<- CreateTableOne(vars=xvars,strata="test_indicator", data=prematchdata_b, 
                        test=FALSE)
## include standardized mean difference (SMD)
print(table1,smd=TRUE)

#randomly sort data for matching (it finds first neighbor)
set.seed(6546)
prematchdata_b<- prematchdata_b[sample(nrow(prematchdata_b)),]
treatment<-prematchdata_b$test_indicator
greedymatch<-Match(Tr=treatment,M=1,X=prematchdata_b[xvars],replace=FALSE,caliper=0.2)
summary(greedymatch)
matched<-prematchdata_b[unlist(greedymatch[c("index.treated","index.control")]), ]

#get table 1 for matched data with standardized differences
matchedtab1<-CreateTableOne(vars=xvars, strata ="test_indicator", 
                            data=matched, test = FALSE)
print(matchedtab1, smd = TRUE)

#outcome analysis
for (i in 1:length(xvars)){
  y_trt<-matched[matched$test_indicator==1,xvars[i]]
  y_con<-matched[matched$test_indicator==0,xvars[i]]
  diffy<-y_trt-y_con
  print(paste("ttest for",xvars[i]))
  print(t.test(diffy))
  plot(diffy,main=xvars[i])
}


y_trt<-matched[matched$test_indicator==1,"new_1718_growth"]
y_con<-matched[matched$test_indicator==0,"new_1718_growth"]
diffy<-y_trt-y_con
t.test(diffy)
plot(diffy,main="new_1718_growth")



#Propensity Score Matching
psmodel<-glm(test_indicator~total_17+new_1617_growth+prior_1617_growth+
               avg_nac_17+avg_cltotagi_17+prct_eitc_17,
             family=binomial(),
             data=prematchdata_b)
summary(psmodel)
pscore<-psmodel$fitted.values

#do greedy matching on logit(PS) using Match with a caliper
logit<-function(p) {log(p)-log(1-p)}
psmatch<-Match(Tr=prematchdata_b$test_indicator,
               M=1,
               X=logit(pscore),
               replace=FALSE,
               caliper=.001)
matched<-prematchdata_b[unlist(psmatch[c("index.treated","index.control")]),]
#get standardized differences
matchedtab1<-CreateTableOne(vars=xvars, strata ="test_indicator", 
                            data=matched, test = FALSE)
print(matchedtab1, smd = TRUE)


#outcome analysis
for (i in 1:length(xvars)){
  y_trt<-matched[matched$test_indicator==1,xvars[i]]
  y_con<-matched[matched$test_indicator==0,xvars[i]]
  diffy<-y_trt-y_con
  print(paste("ttest for",xvars[i]))
  print(t.test(diffy))
  plot(diffy,main=xvars[i])
}


y_trt<-matched[matched$test_indicator==1,"new_1718_growth"]
y_con<-matched[matched$test_indicator==0,"new_1718_growth"]
diffy<-y_trt-y_con
t.test(diffy)
plot(diffy,main="new_1718_growth")







